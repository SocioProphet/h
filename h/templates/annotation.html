<!-- Top controls -->
<div data-ng-hide="editing" class="magicontrols">
  <!-- Reply count -->
  <span data-ng-show="directChildren()"
        data-ng-pluralize=""
        count="allChildren()"
        when="{one: '1 reply', other: '{} replies'}"
        class="reply-count" />
  <span data-ng-bind="model.$viewValue.created | fuzzyTime | date:'mediumDate'"
        class="time" />

  <div class="vis-icon" title="Visibility"
       data-ng-show="model.$viewValue.privacy.name != 'Public'" />
  <div class="fave-icon show" title="Favorite"
       data-ng-click="favorite()" />
  <div class="show reply-icon" title="Reply"
       data-ng-show="model.$viewValue.user | notDeletedUser"
       data-ng-click="reply()" />
  <div class="show share-icon" title="Share"
       data-ng-click="share()" />
  <div class="show dropdown" title="More Actions">
    <div class="dropdown-toggle down-icon" role="button" />
    <ul class="dropdown-menu pull-right" role="menu">
      <li data-ng-show="authorize('update')" data-ng-click="edit()">Edit</li>
      <li data-ng-show="authorize('delete')" data-ng-click="delete()">Delete</li>
      <li data-ng-click="flag()">Flag</li>
    </ul>
  </div>
</div>

<h3 data-ng-bind="model.$viewValue.user | userName" class="upper-left" />
<ng-form data-ng-show="editing" name="form">

  <div class="dropdown privacy">
    <a name="privacy"
       role="button"
       class="dropdown-toggle"
       data-ng-model="model.$viewValue.privacy"
       data-toggle="dropdown"
       >{{model.$viewValue.privacy.name}}</a>
    <ul class="dropdown-menu pull-right" role="menu">
      <li data-ng-repeat="p in privacyLevels">
        <a href="" data-ng-click="form.privacy.$setViewValue(p)">{{p.name}}</a>
      </li>
    </ul>
  </div>

  <ng-switch on="action">
    <div class="body preface" data-ng-switch-when="redact" >You are about to delete this annotation:</div>
    <div class="body preface" data-ng-switch-when="edit" >You are about to edit this annotation:</div>
  </ng-switch>
  <div class="body quote" data-ng-show="action=='redact'" data-ng-bind-html="origText"/>
  <ng-switch on="action">
    <textarea data-ng-model="model.$viewValue.text"
 	       data-ng-switch-when="redact"
           class="body"
           name="text"
           placeholder="Please explain why you're deleting this annotation"
           required="" />
    <textarea data-ng-model="model.$viewValue.text"
 	       data-ng-switch-default
           class="body"
           name="text"
           required="" />
  </ng-switch>
  <div class="tip">
    <a href="https://en.wikipedia.org/wiki/Markdown"
       target="_blank">Markdown</a> is supported.
  </div>
</ng-form>
<div class="body preface"
     data-ng-show="$modelValue.redacted && !editing" 
     data-ng-bind-html="model.$viewValue.body | redactionReason"
     />
<div data-ng-bind-html="model.$viewValue.body"
     data-ng-hide="editing"
     class="body"/>

<!-- Bottom controls -->
<div class="buttonbar">
  <div data-ng-show="editing" class="annotator-controls">
    <ng-switch on="action">
        <button data-ng-switch-when="edit" data-ng-click="save()" class="btn check-icon" >Edit</button>
        <button data-ng-switch-when="redact" data-ng-click="save()" class="btn check-icon" >Delete</button>
        <button data-ng-switch-default data-ng-click="save()" class="btn check-icon" >Save</button>
    </ng-switch>
    <a data-ng-click="cancel()" class="x-icon">Cancel</a>
  </div>
</div>

<!-- Editing preview -->
<div data-ng-show="previewText" class="preview">
  <h4>Preview</h4>
  <div data-ng-bind-html="previewText" class="body" />
</div>
